<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script type="text/javascript" src="w2g.js"></script>
    <title>MarkedMap</title>

    <link rel="manifest" href="manifest.json">
</head>
<script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=ZMFBZ-JCICK-WUBJ3-ACSIA-CJYS7-YMBRS"></script>
<style type="text/css">
    html,
    body {
        height: 100%;
        margin: 0px;
        padding: 0px;
    }

    #container {
        width: 100%;
        height: 100%;
    }
    #markDetail{
        position: fixed;
        right: 0;
        top: 0;
        z-index: 9999;
        background-color: cyan;
    }
    #showCurrent{
        position: fixed;
        left: 10%;
        bottom: 30%;
        z-index: 10000;
        background-color: lightgreen;
        border-width: 0;
    }
    #markPrefixInput{
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10000;
    }
</style>


<body onload="initMap()">
    <button id='showCurrent'>x</button>
    <input id='markPrefixInput' type="text">
    <div id='markDetail'>
        <a href="https://test.sadyn.top/webpack/tmapdemo/dist/">tmap</a>
        detail <div id='postionDisplay'> lat ,lng</div>
        <button id='hideDetail'>hide</button>
        <button id='deleteMark'>delete</button>
        <ul id='markDetailUl'></ul>
    </div>
    <div id="container"></div>
    <script type="text/javascript">
        let tg={}
        let tg1={}

        let markPrefixInput=document.querySelector('#markPrefixInput');
        let deleteMarkButton=document.querySelector('#deleteMark');
        let markDetailDisplay=document.querySelector('#markDetail')
        let markDetailUl=document.querySelector('#markDetailUl')
        let showCurrentButton=document.querySelector('#showCurrent')
        let hideButton=document.querySelector('#hideDetail')

        let selectedMarkID='';
        var options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 3000
        };

        hideButton.addEventListener('click',(evt)=>{
            markDetailUl.innerHTML=''
        })
        deleteMarkButton.addEventListener('click',(evt)=>{
            deleteLabel(selectedMarkID);
        })
        



        function initMap() {
            console.log('start init')
            navigator.geolocation.getCurrentPosition(success, error, options);

            function success(pos) {
                var crd = pos.coords;

                console.log("Your current position is:");
                console.log(`Latitude : ${crd.latitude}`);
                console.log(`Longitude: ${crd.longitude}`);
                console.log(`More or less ${crd.accuracy} meters.`);

                let gcrd = wgs2gcj(crd.latitude, crd.longitude);
                tg1=gcrd;
                var center = new TMap.LatLng(gcrd.lat, gcrd.lng);
                //初始化地图
                var map = new TMap.Map("container", {
                    rotation: 20, //设置地图旋转角度
                    pitch: 30, //设置俯仰角度（0~45）
                    zoom: 18, //设置地图缩放级别
                    center: center, //设置地图中心点坐标
                    viewMode: "2D",
                    mapStyleId: 'style2'
                });
                map.setDoubleClickZoom(false)
                // var mapCenter = map.getCenter(); //获取地图中心点坐标
                // mapCenter.getLat(); mapCenter.getLng();

                let labels = JSON.parse(localStorage.getItem('labels'));
                if(labels===null){
                    labels=[]
                }
                for (const lable of labels) {
                    creatLable(lable.id,lable.content,lable.position,map)
                }



                //初始化marker图层
                var markerLayer = new TMap.MultiMarker({
                    id: 'marker-layer',
                    map: map
                });
                tg=markerLayer;
                markerLayer.add({
                        position: new TMap.LatLng(gcrd.lat,gcrd.lng)
                });
                
                
                let oldgcrd=gcrd;
                
                let crdChangeThredhod=0.00001
                navigator.geolocation.watchPosition(pos=>{
                    console.log('locatin changed')
                    var crd = pos.coords;
                    let gcrd = wgs2gcj(crd.latitude, crd.longitude);
                    if(Math.abs(oldgcrd.lat-gcrd.lat)<crdChangeThredhod && Math.abs(oldgcrd.lng-gcrd.lng)<crdChangeThredhod){
                        console.log('small change will not update')
                        return;
                    }
                    oldgcrd=gcrd;
                    markerLayer.remove(Object.keys(markerLayer._idSet))
                    markerLayer.add({
                        position: new TMap.LatLng(gcrd.lat,gcrd.lng)
                    })
                    
                },error,options)
                
                showCurrentButton.addEventListener('click',()=>{
                    console.log(oldgcrd)
                    setCenter(map,oldgcrd.lat,oldgcrd.lng)
                })
                

                //监听点击事件添加marker
             
                map.on("click", (evt) => {
                    
                    if(markPrefixInput.value.length<1){
                        return;
                    }
                    let content =  prompt('location title', markPrefixInput.value);
                    
                    if (content.length <=markPrefixInput.value.length) {
                        return;
                    }
                    //初始化label
                    let label = new TMap.MultiLabel({
                        id: 'label-layer' + Math.random(),
                        map: map,
                        enableCollision:true,
                        styles: {
                            'label': new TMap.LabelStyle({
                                'color': '#3777FF', //颜色属性
                                'size': 15, //文字大小属性
                                'offset': { x: 0, y: 0 }, //文字偏移属性单位为像素
                                'angle': 0, //文字旋转属性
                                'alignment': 'center', //文字水平对齐属性
                                'verticalAlignment': 'middle' //文字垂直对齐属性
                            })
                        },
                        geometries: [{
                            'id': 'label', //点图形数据的标志信息
                            'styleId': 'label', //样式id
                            'position': new TMap.LatLng(evt.latLng.lat, evt.latLng.lng), //标注点位置
                            'content': content, //标注文本
                            'properties': { //标注点的属性数据
                                'title': 'label'
                            }
                        }]
                    });
                    let lableObj = {
                        id:label.id,
                        content,
                        position: gcj2wgs(evt.latLng.lat, evt.latLng.lng)
                    };
                    let oldlabels = JSON.parse(localStorage.getItem('labels'));
                    if (oldlabels === null) {
                        oldlabels = []
                    }
                    oldlabels.push(lableObj);
                    localStorage.setItem('labels', JSON.stringify(oldlabels));
                });





                setInterval(() => {
                    navigator.geolocation.getCurrentPosition((res) => {
                        let postionDisplay = document.querySelector('#postionDisplay');
                        postionDisplay.innerHTML = res.coords.latitude.toFixed(5) + ',' + res.coords.longitude.toFixed(5);

                    },
                        () => console.log('err at get loc'), options)
                }, 1000);
            }


            function error(err) {
                console.warn(`ERROR(${err.code}): ${err.message}`);
            }


        }

        function creatLable(id,content, position,map) {
           
            let shortContent=content.match(/\d+/);
            if(shortContent===null){
                shortContent=content.substring(0,6)
            }
            else{
                shortContent=shortContent.toString()
            }
            console.log(shortContent,'short',content)
            let gposition=wgs2gcj(position.lat,position.lng);
           
            let label = new TMap.MultiLabel({
                id: id.length>0?id : 'label-layer' + Math.random(),
                map: map,
                styles: {
                    'label': new TMap.LabelStyle({
                        'color': '#3777FF', //颜色属性
                        'size': 12, //文字大小属性
                        'offset': { x: 0, y: 0 }, //文字偏移属性单位为像素
                        'angle': 0, //文字旋转属性
                        'alignment': 'center', //文字水平对齐属性
                        'verticalAlignment': 'middle' //文字垂直对齐属性
                    })
                },
                geometries: [{
                    'id': 'label', //点图形数据的标志信息
                    'styleId': 'label', //样式id
                    'position': new TMap.LatLng(gposition.lat,gposition.lng), //标注点位置
                    'content': shortContent, //标注文本
                    'properties': { //标注点的属性数据
                        'title': 'label'
                    }
                }]
            });
            label.on('click',evt=>{
                console.log('lable clicked',evt);
                selectedMarkID=evt.target.id;
                let  glatLng=evt.latLng;
                let latLng=gcj2wgs(glatLng.lat,glatLng.lng)


                markDetailUl.innerHTML=`
                    <li> ${selectedMarkID}</li>
                    <li style="width: 200px;"> ${content}</li>
                    <li> r ${latLng.lat.toFixed(6) +' ' +latLng.lng.toFixed(6)}</li>
                    <li> g ${glatLng.lat.toFixed(6) +' ' +glatLng.lng.toFixed(6)}</li>

                `
            })
        }


        function getLabels(){
            console.log(JSON.parse(localStorage.getItem('labels')))
            return JSON.parse(localStorage.getItem('labels'))
        }
        function setLabels(labelobj) {
            localStorage.setItem('labels',JSON.stringify(labelobj));
        }

        function deleteLabel(id) {
            let labels=getLabels();
            let newLabels=labels.filter(i=>i.id!==id);
            setLabels(newLabels);
        }

        function setCenter(map,lat,lng) {
            map.setCenter(new TMap.LatLng(lat,lng));//坐标为天安门
        }
    </script>
</body>

</html>